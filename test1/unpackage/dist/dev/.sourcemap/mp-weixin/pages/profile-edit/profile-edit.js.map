{"version":3,"file":"profile-edit.js","sources":["pages/profile-edit/profile-edit.vue","C:/Users/30302/Documents/HBuilderX.4.76.2025082103/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvcHJvZmlsZS1lZGl0L3Byb2ZpbGUtZWRpdC52dWU"],"sourcesContent":["<template>\n\t<view class=\"container\">\n\t\t<view class=\"form-card\">\n\t\t\t\n\t\t\t<view class=\"form-item\" @click=\"chooseAvatar\">\n\t\t\t\t<text class=\"label\">头像</text>\n\t\t\t\t<view class=\"item-right\">\n\t\t\t\t\t<image class=\"avatar-preview\" :src=\"displayAvatar\" mode=\"aspectFill\"></image>\n\t\t\t\t\t<uni-icons type=\"right\" size=\"16\" color=\"#999\"></uni-icons>\n\t\t\t\t</view>\n\t\t\t</view>\n\n\t\t\t<view class=\"form-item\">\n\t\t\t\t<text class=\"label\">帐号</text>\n\t\t\t\t<view class=\"item-right\">\n\t\t\t\t\t<text class=\"input-display\">{{ form.username }}</text>\n\t\t\t\t</view>\n\t\t\t</view>\n\t\t\t\n\t\t\t<view class=\"form-item\">\n\t\t\t\t<text class=\"label\">昵称</text>\n\t\t\t\t<view class=\"item-right\">\n\t\t\t\t\t<input class=\"input\" v-model=\"form.nickname\" placeholder-class=\"input-placeholder\" placeholder=\"请输入昵称\" />\n\t\t\t\t</view>\n\t\t\t</view>\n\t\t\t\n\t\t\t<view class=\"form-item\">\n\t\t\t\t<text class=\"label\">性别</text>\n\t\t\t\t<picker mode=\"selector\" :range=\"genderOptions\" :value=\"form.gender\" @change=\"onGenderChange\" style=\"flex: 1;\">\n\t\t\t\t\t<view class=\"item-right\">\n\t\t\t\t\t\t<text class=\"input\" :class=\"{'input-placeholder': form.gender === 0}\">\n\t\t\t\t\t\t\t{{ genderText }}\n\t\t\t\t\t\t</text>\n\t\t\t\t\t\t<uni-icons type=\"right\" size=\"16\" color=\"#999\"></uni-icons>\n\t\t\t\t\t</view>\n\t\t\t\t</picker>\n\t\t\t</view>\n\t\t\t\n\t\t\t<view class=\"form-item\">\n\t\t\t\t<text class=\"label\">生日</text>\n\t\t\t\t<picker mode=\"date\" :value=\"form.birthday\" @change=\"onBirthdayChange\" style=\"flex: 1;\">\n\t\t\t\t\t<view class=\"item-right\">\n\t\t\t\t\t\t<text class=\"input\" :class=\"{'input-placeholder': !form.birthday}\">\n\t\t\t\t\t\t\t{{ form.birthday || '请选择生日' }}\n\t\t\t\t\t\t</text>\n\t\t\t\t\t\t<uni-icons type=\"right\" size=\"16\" color=\"#999\"></uni-icons>\n\t\t\t\t\t</view>\n\t\t\t\t</picker>\n\t\t\t</view>\n\t\t\t\n\t\t\t<view class=\"form-item\">\n\t\t\t\t<text class=\"label\">新密码</text>\n\t\t\t\t<view class=\"item-right\">\n\t\t\t\t\t<input class=\"input\" type=\"password\" v-model=\"form.password\" placeholder-class=\"input-placeholder\" placeholder=\"不修改请留空\" />\n\t\t\t\t</view>\n\t\t\t</view>\n\t\t\t\n\t\t\t<view class=\"form-item\">\n\t\t\t\t<text class=\"label\">确认密码</text>\n\t\t\t\t<view class=\"item-right\">\n\t\t\t\t\t<input class=\"input\" type=\"password\" v-model=\"confirmPassword\" placeholder-class=\"input-placeholder\" placeholder=\"请再次输入新密码\" />\n\t\t\t\t</view>\n\t\t\t</view>\n\t\t\t\n\t\t\t<view class=\"form-item\">\n\t\t\t\t<text class=\"label\">手机号</text>\n\t\t\t\t<view class=\"item-right\">\n\t\t\t\t\t<input class=\"input\" type=\"number\" v-model=\"form.phone\" placeholder-class=\"input-placeholder\" placeholder=\"请输入手机号\" />\n\t\t\t\t</view>\n\t\t\t</view>\n\t\t</view>\n\t\t\n\t\t<view class=\"button-group\">\n\t\t\t<button class=\"btn btn-cancel\" @click=\"onCancel\">取消</button>\n\t\t\t<button class=\"btn btn-confirm\" @click=\"onSubmit\" :loading=\"isSubmitting\">确认修改</button>\n\t\t</view>\n\t</view>\n</template>\n\n<script>\n\t// 确保这里的 IP 和你的后端一致 (真机调试不能用 localhost)\n\tconst API_BASE_URL = 'http://127.0.0.1:8081'; \n\tconst DEFAULT_AVATAR = '/static/avatar.png'; // 默认头像\n\n\texport default {\n\t\tdata() {\n\t\t\treturn {\n\t\t\t\t// 对应后端的 User 实体\n\t\t\t\tform: {\n\t\t\t\t\tid: null,\n\t\t\t\t\tusername: '', // 帐号只读\n\t\t\t\t\tnickname: '',\n\t\t\t\t\tgender: 0,    // 0:保密, 1:男, 2:女\n\t\t\t\t\tbirthday: '',\n\t\t\t\t\tphone: '',\n\t\t\t\t\tavatarUrl: '', // 存相对路径 /images/xxx.jpg\n\t\t\t\t\tpassword: ''   // 可选，修改密码时才填\n\t\t\t\t},\n\t\t\t\tconfirmPassword: '', // 前端辅助字段\n\t\t\t\tgenderOptions: ['保密', '男', '女'], // 对应索引 0, 1, 2\n\t\t\t\tisSubmitting: false\n\t\t\t}\n\t\t},\n\t\tcomputed: {\n\t\t\t// 计算头像完整路径 (用于 <image src=\"...\">)\n\t\t\tdisplayAvatar() {\n\t\t\t\tif (this.form.avatarUrl) {\n\t\t\t\t\t// 如果已经是完整 http 路径则直接用，否则拼接\n\t\t\t\t\tif (this.form.avatarUrl.startsWith('http')) return this.form.avatarUrl;\n\t\t\t\t\treturn API_BASE_URL + this.form.avatarUrl;\n\t\t\t\t}\n\t\t\t\treturn DEFAULT_AVATAR;\n\t\t\t},\n\t\t\t// 计算性别显示文本\n\t\t\tgenderText() {\n\t\t\t\t// 简单的索引映射\n\t\t\t\treturn this.genderOptions[this.form.gender] || '请选择性别';\n\t\t\t}\n\t\t},\n\t\tonLoad() {\n\t\t\tthis.loadUserProfile();\n\t\t},\n\t\tmethods: {\n\t\t\t// 1. 加载本地缓存的用户信息回显\n\t\t\tloadUserProfile() {\n\t\t\t\tconst userInfo = uni.getStorageSync('userInfo');\n\t\t\t\tif (userInfo) {\n\t\t\t\t\t// 浅拷贝数据，避免直接修改缓存\n\t\t\t\t\tthis.form.id = userInfo.id;\n\t\t\t\t\tthis.form.username = userInfo.username;\n\t\t\t\t\tthis.form.nickname = userInfo.nickname;\n\t\t\t\t\tthis.form.gender = userInfo.gender || 0;\n\t\t\t\t\tthis.form.birthday = userInfo.birthday;\n\t\t\t\t\tthis.form.phone = userInfo.phone;\n\t\t\t\t\tthis.form.avatarUrl = userInfo.avatarUrl;\n\t\t\t\t\t// 密码字段初始为空，不回显加密后的哈希值\n\t\t\t\t\tthis.form.password = ''; \n\t\t\t\t} else {\n\t\t\t\t\tuni.showToast({ title: '未登录', icon: 'none' });\n\t\t\t\t\tsetTimeout(() => uni.reLaunch({ url: '/pages/login/login' }), 1500);\n\t\t\t\t}\n\t\t\t},\n\n\t\t\t// 2. 选择并上传头像\n\t\t\tchooseAvatar() {\n\t\t\t\tuni.chooseImage({\n\t\t\t\t\tcount: 1,\n\t\t\t\t\tsizeType: ['compressed'],\n\t\t\t\t\tsuccess: (res) => {\n\t\t\t\t\t\tconst tempFilePath = res.tempFilePaths[0];\n\t\t\t\t\t\tthis.uploadAvatar(tempFilePath);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t},\n\n\t\t\t// 3. 执行文件上传\n\t\t\tuploadAvatar(filePath) {\n\t\t\t\tuni.showLoading({ title: '上传中...' });\n\t\t\t\tuni.uploadFile({\n\t\t\t\t\turl: API_BASE_URL + '/api/upload', // 你的后端上传接口\n\t\t\t\t\tfilePath: filePath,\n\t\t\t\t\tname: 'file',\n\t\t\t\t\tsuccess: (uploadRes) => {\n\t\t\t\t\t\t// uploadFile 返回的是 String，需要手动 parse\n\t\t\t\t\t\tconst data = JSON.parse(uploadRes.data);\n\t\t\t\t\t\tif (data.success) {\n\t\t\t\t\t\t\t// 后端返回相对路径 \"/images/uuid.jpg\"\n\t\t\t\t\t\t\tthis.form.avatarUrl = data.filePath;\n\t\t\t\t\t\t\tuni.showToast({ title: '上传成功', icon: 'none' });\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tuni.showToast({ title: '上传失败', icon: 'none' });\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\tfail: () => {\n\t\t\t\t\t\tuni.showToast({ title: '网络错误', icon: 'none' });\n\t\t\t\t\t},\n\t\t\t\t\tcomplete: () => {\n\t\t\t\t\t\tuni.hideLoading();\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t},\n\n\t\t\t// 4. 性别选择器回调\n\t\t\tonGenderChange(e) {\n\t\t\t\tthis.form.gender = parseInt(e.detail.value);\n\t\t\t},\n\n\t\t\t// 5. 生日选择器回调\n\t\t\tonBirthdayChange(e) {\n\t\t\t\tthis.form.birthday = e.detail.value;\n\t\t\t},\n\n\t\t\t// 6. 提交保存\n\t\t\tonSubmit() {\n\t\t\t\t// --- 简单校验 ---\n\t\t\t\tif (this.form.password && this.form.password !== this.confirmPassword) {\n\t\t\t\t\tuni.showToast({ title: '两次输入的密码不一致', icon: 'none' });\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tthis.isSubmitting = true;\n\n\t\t\t\t// 构建提交的数据 (如果不修改密码，发送 null 或空串给后端)\n\t\t\t\t// 注意：这里我们不发送 username，因为一般不允许改帐号\n\t\t\t\tconst postData = {\n\t\t\t\t\t...this.form\n\t\t\t\t};\n\t\t\t\t// 如果密码为空，后端逻辑会忽略它\n\t\t\t\tif (!postData.password) {\n\t\t\t\t\tpostData.password = null;\n\t\t\t\t}\n\n\t\t\t\tuni.request({\n\t\t\t\t\turl: API_BASE_URL + '/api/user/update',\n\t\t\t\t\tmethod: 'POST',\n\t\t\t\t\tdata: postData,\n\t\t\t\t\tsuccess: (res) => {\n\t\t\t\t\t\tif (res.data.success) {\n\t\t\t\t\t\t\tuni.showToast({ title: '保存成功' });\n\t\t\t\t\t\t\t// 更新本地缓存\n\t\t\t\t\t\t\tuni.setStorageSync('userInfo', res.data.data);\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t// 1.5秒后返回上一页\n\t\t\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\t\t\tthis.onCancel();\n\t\t\t\t\t\t\t}, 1500);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tuni.showToast({ title: res.data.message || '保存失败', icon: 'none' });\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\tfail: () => {\n\t\t\t\t\t\tuni.showToast({ title: '请求失败，请检查网络', icon: 'none' });\n\t\t\t\t\t},\n\t\t\t\t\tcomplete: () => {\n\t\t\t\t\t\tthis.isSubmitting = false;\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t},\n\n\t\t\tonCancel() {\n\t\t\t\tuni.navigateBack({ delta: 1 });\n\t\t\t}\n\t\t}\n\t}\n</script>\n\n<style lang=\"scss\" scoped>\n\t/* 保持你原有的样式不变 */\n\t.form-card {\n\t\tpadding: 10rpx 30rpx;\n\t\tbackground-color: #ffffff;\n\t\tborder-radius: 16rpx;\n\t\tmargin-top: 20rpx;\n\t}\n\n\t.form-item {\n\t\tdisplay: flex;\n\t\tjustify-content: space-between;\n\t\talign-items: center;\n\t\tpadding: 30rpx 0;\n\t\tborder-bottom: 1rpx solid #f5f5f5;\n\t\t\n\t\t&:last-child {\n\t\t\tborder-bottom: none;\n\t\t}\n\t}\n\t\n\t.label {\n\t\tfont-size: 30rpx;\n\t\tcolor: #333;\n\t\twidth: 180rpx;\n\t\tflex-shrink: 0;\n\t}\n\t\n\t.item-right {\n\t\tflex: 1;\n\t\tdisplay: flex;\n\t\talign-items: center;\n\t\tjustify-content: flex-end;\n\t\t/* 确保点击区域铺满 */\n\t\tmin-height: 40rpx; \n\t}\n\t\n\t.input {\n\t\tfont-size: 30rpx;\n\t\ttext-align: right;\n\t\tcolor: #333;\n\t\twidth: 100%; /* 让 input 在容器内占满 */\n\t}\n\t\n\t.input-placeholder {\n\t\tcolor: #999;\n\t}\n\t\n\t.input-display {\n\t\tfont-size: 30rpx;\n\t\tcolor: #999;\n\t}\n\t\n\t.avatar-preview {\n\t\twidth: 100rpx;\n\t\theight: 100rpx;\n\t\tborder-radius: 50%;\n\t\tbackground-color: #eee;\n\t\tmargin-right: 10rpx;\n\t\tborder: 1rpx solid #f0f0f0;\n\t}\n\t\n\t.button-group {\n\t\tdisplay: flex;\n\t\tjustify-content: space-between;\n\t\tmargin-top: 60rpx;\n\t\tpadding: 0 10rpx;\n\t}\n\t\n\t.btn {\n\t\twidth: calc(50% - 20rpx);\n\t\theight: 88rpx;\n\t\tline-height: 88rpx;\n\t\tborder-radius: 44rpx;\n\t\tfont-size: 30rpx;\n\t\tfont-weight: bold;\n\t}\n\t\n\t.btn-cancel {\n\t\tbackground-color: #f0f0f0;\n\t\tcolor: #555;\n\t}\n\t\n\t.btn-confirm {\n\t\tbackground-color: #007AFF;\n\t\tcolor: #ffffff;\n\t}\n\t\n\t/* 按钮点击态 */\n\t.btn-confirm:active {\n\t\topacity: 0.8;\n\t}\n</style>","import MiniProgramPage from 'D:/my-fullstack-project/test1/pages/profile-edit/profile-edit.vue'\nwx.createPage(MiniProgramPage)"],"names":["uni"],"mappings":"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"}